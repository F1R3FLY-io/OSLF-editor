#!/bin/bash

# Pre-push hook to run CI tests locally before pushing
# This ensures the CI will pass on GitHub Actions

# Get current branch name
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Only run CI tests on main branch
if [ "$CURRENT_BRANCH" != "main" ]; then
    echo ""
    echo "‚ÑπÔ∏è  Skipping CI tests (not on main branch: $CURRENT_BRANCH)"
    echo ""
    exit 0
fi

echo ""
read -p "üîç Run CI tests before push? (y/N): " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚è≠Ô∏è  Skipping CI tests"
    echo ""
    exit 0
fi

echo ""
echo "üîç Running CI tests..."
echo ""

# Check if gh CLI is available
if ! command -v gh &> /dev/null; then
    echo "‚ö†Ô∏è  Warning: 'gh' (GitHub CLI) is not installed. Skipping CI tests."
    echo "To enable local CI testing, install GitHub CLI:"
    echo "  https://cli.github.com/"
    echo ""
    exit 0
fi

# Check if gh act extension is available
if ! gh act --version &> /dev/null; then
    echo "‚ö†Ô∏è  Warning: 'gh act' extension is not installed. Skipping CI tests."
    echo "To enable local CI testing, install the gh act extension:"
    echo "  gh extension install https://github.com/nektos/gh-act"
    echo ""
    exit 0
fi

# Check if Docker is available
if ! command -v docker &> /dev/null; then
    echo "‚ö†Ô∏è  Warning: Docker is not available. Skipping CI tests."
    echo "gh act requires Docker to run GitHub Actions locally."
    echo "Install Docker: https://docs.docker.com/get-docker/"
    echo ""
    exit 0
fi

# Run the GitHub Pages build job
if gh act -e .github/workflows/.event.json --action-offline-mode -W .github/workflows/github-pages.yml -j build; then
    echo ""
    echo "‚úÖ All tests passed! Proceeding with push..."
    echo ""
    exit 0
else
    echo ""
    echo "‚ùå CI tests failed! Push aborted."
    echo "Fix the errors and try again."
    echo "To skip this check, use: git push --no-verify"
    echo ""
    exit 1
fi
